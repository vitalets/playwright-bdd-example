image: repository.desk.csez.zohocorpin.com/base-image/testing-framework-gitlab-runne-base:v3

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_PIPELINE_SOURCE == "web"
      when: always

stages:
  - build
  - unit
  - uat

default:
  cache:
    key: build-cache
    paths:
      - node_modules
      - build
      - npm-shrinkwrap.json

# Install dependencies stage
build:
  stage: build
  script:
    - npm -v
    - node -v
    - npm install --ignore-scripts
    - npm run build
    - npm install
    - npm shrinkwrap
    - npm run build

# Unit tests stage
unit:
  stage: unit
  script:
    - npm run test
  artifacts:
    when: always
    paths:
      - unit_reports

# UAT tests stage
uat-auth:
  stage: uat
  script:
    - cd examples
    - npm install $(npm pack ../../testing-framework | tail -1)
    - output=$(npm run uatauth)
    - echo "$output"
    - node ../ValidateUATReport.js examples

  artifacts:
    when: always
    paths:
      - examples/uat/playwright-report

uat-noauth:
  stage: uat
  script:
    - cd examples
    - npm install $(npm pack ../../testing-framework | tail -1)
    - output=$(npm run uatnoauth)
    - echo "$output"
    - node ../ValidateUATReport.js examples

  artifacts:
    when: always
    paths:
      - examples/uat/playwright-report
    
uat-profile:
  stage: uat
  script:
    - cd examples
    - npm install $(npm pack ../../testing-framework | tail -1)
    - output=$(npm run uatprofile)
    - echo "$output"
    - node ../ValidateUATReport.js examples

  artifacts:
    when: always
    paths:
      - examples/uat/playwright-report 


uat-unauth:
  stage: uat
  script:
    - cd examples
    - npm install $(npm pack ../../testing-framework | tail -1)
    - output=$(npm run uatunauth)
    - echo "$output"
    - node ../ValidateUATReport.js examples


  artifacts:
    when: always
    paths:
      - examples/uat/playwright-report 

uat-nobdd:
  stage: uat
  script:
    - cd nobdd
    - npm install $(npm pack ../../testing-framework | tail -1)
    - output=$(npm run uatnobdd -- --headless)
    - echo "$output"
    - node ../ValidateUATReport.js nobdd


  artifacts:
    when: always
    paths:
      - nobdd/uat/playwright-report


uatmodule:
  stage: uat
  script:
    - cd examples
    - npm install $(npm pack ../../testing-framework | tail -1)
    - output=$(npm run uatmodule)
    - echo "$output"
    - node ../ValidateUATReport.js examples


  artifacts:
    when: always
    paths:
      - examples/uat/playwright-report

uatconfigmodule:
  stage: uat
  script:
    - cd examples
    - npm install $(npm pack ../../testing-framework | tail -1)
    - output=$(npm run uatconfigmodule)
    - echo "$output"
    - node ../ValidateUATReport.js examples

  artifacts:
    when: always
    paths:
      - examples/uat/playwright-report

      